{% extends "base.html" %}

{% block title %} Title1 {% endblock %}

{% block content %}
<div class="container" style="margin-left: 10px;">
  {% if bund.image %}
    <img src="{{ bund.image.url }}"
         style="float: left; width: 25%; height: 100%; object-fit: cover; border-radius: 10px; margin: 10px; margin-bottom: 0;">
  {% endif %}

   

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">{{ bund.title }}</h1>
    {% if bund.author %}
        <a href="{% url 'UserInterface' bund.author %}">
          <h2 class="mb-0 text-end">
            <span class="badge bg-secondary fs-6 p-2 fst-italic">
                Author: {{ bund.author }}
            </span>
        </h2>
        </a>
    {% endif %}
</div>
  <p class="fs-5">{{ bund.description }}</p>
  <br>

  <button id="LikeBTN" {% if request.user.is_authenticated %} class="btn btn-success btn-lg" {% else %} class ="btn btn-secondary" disabled {% endif %}>
    <span id="likes-emoji">
      {% if request.user in bund.likes.all %}
        ♥︎
      {% else %}
        ♡
      {% endif %}
    </span>
    <span id="likes-count">{{bund.likes_count}}</span>
  </button>
  <a href="{% url 'Create_Problem' bund.id %}" id="LikeBTN" class="btn btn-success btn-lg">Add problem</a>

  <br><br>
  {% if not request.user.is_authenticated %}
    <a href="{% url 'Login' %}" class="btn btn-info btn-lg" style="color: white;">
     Not logged in? Click here to log in.
    </a>
  {% endif %}

  <div>
    {% include 'grid_display.html' %}
  </div>

<div style="clear: both;"></div>
<br>
<script>
document.addEventListener("DOMContentLoaded", function() {
  const LikeBTN = document.getElementById('LikeBTN')

  LikeBTN.addEventListener("click", function() {

    fetch("{% url 'Like_Bundle' bund.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(data => {
        // Cambiar icono segun estado
        document.getElementById("likes-emoji").textContent = data.liked ? "♥︎" : "♡";

        // Actualizar número mostrado
        document.getElementById("likes-count").textContent = data.likes_count;
    });
  });
});

function checkStatus() {
    fetch("{% url 'check_bundle_status' bund.id %}")
    .then(res => res.json())
    .then(data => {
      console.log(data)
        if (data.ready) {
            
            location.reload(); // recarga la página
        } else if (data.retry){
          setTimeout(checkStatus, 3000); // vuelve a chequear en 3s
        }
    });
}
checkStatus();


</script>
{% endblock %}
