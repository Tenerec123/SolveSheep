{% extends "base.html" %}

{% block title %} Title1 {% endblock %}

{% block content %}
<div class="container" style="margin-left: 10px;">
  {% if prob.image %}
    <img src="{{ prob.image.url }}"
         style="float: left; width: 25%; height: 100%; object-fit: cover; border-radius: 10px; margin: 10px; margin-bottom: 0;">
  {% endif %}

   <span class="badge" 
   style="box-shadow: 0 0 10px {{prob.dif_tag.color}}; text-shadow: 1px 1px 5px gray; background-color: {{ prob.dif_tag.color }}; color: white; margin-right: 8px;">
      {{ prob.dif_tag.name }}
    </span>

  {% for type in prob.type_tags.all %}
    <span class="badge" style="background-color: {{ type.color }}; color: white;">
       {{ type.name }}
    </span>
  {% endfor %}
   
<div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="mb-0">{{ prob.title }}</h1>
    {% if prob.author %}
        <a href="{% url 'UserInterface' prob.author %}">
          <h2 class="mb-0 text-end">
            <span class="badge bg-secondary fs-6 p-2 fst-italic">
                Author: {{ prob.author }}
            </span>
        </h2>
        </a>
    {% endif %}
</div>

  <p class="fs-5">{{ prob.text|linebreaksbr }}</p>
  <br>

  <button id="LikeBTN" {% if request.user.is_authenticated %} class="btn btn-success btn-lg" {% else %} class ="btn btn-secondary" disabled {% endif %}>
    <span id="likes-emoji">
      {% if request.user in prob.likes.all %}
        ♥︎
      {% else %}
        ♡
      {% endif %}
    </span>
    <span id="likes-count">{{prob.likes_count}}</span>
  </button>

  

  <!-- Botón único -->
  <button {% if request.user.is_authenticated %} id="toggle-sol" class="btn btn-success btn-lg" {% else %} class="btn btn-secondary" disabled {% endif %}>
    Show solutions
  </button>

  {% if prob.video %}
      <a href="{{prob.video}}" class="btn btn-primary btn-lg" tabindex="-1" role="button" target="_blank" aria-disabled="true">Video with the solution</a>
  {% endif %}

  <br><br>
  {% if not request.user.is_authenticated %}

    <a href="{% url 'Login' %}" class="btn btn-info btn-lg" style="color: white;">
     Not logged in? Click here to log in.
    </a>

  {% endif %}

  <!-- Contenedor de soluciones -->
  <div id="solutions-container" {% if not solutions %}hidden{% endif %}>
    {% for solution in solutions %}
      <h2 class="mb-0">
        <span class="badge bg-secondary fs-6 p-2 fst-italic">
        
          Author {{ solution.author }}
        </span>
      </h2>
      <br>
      <p>{{ solution.text|linebreaksbr}}</p>

    {% empty %}

    <a href="{% url 'SendSolution' prob.id %}" class="btn btn-secondary btn-lg" style="color: white;">
     There is no solution yet. Click and be the first to solve it.
    </a>

    {% endfor %}
  </div>
</div>

<div style="clear: both;"></div>
<br>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const button = document.getElementById("toggle-sol");
  const container = document.getElementById("solutions-container");

  button.addEventListener("click", function() {
    // Alternar visibilidad en frontend
    container.hidden = !container.hidden;

    // Cambiar texto del botón
    button.textContent = container.hidden ? "Show solutions" : "Hide solutions";

    // Registrar acción en backend
    fetch("{% url 'toggle_solutions' prob.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ show: !container.hidden })
    }).then(res => res.json()).then(data => {
      // opcional: manejar respuesta
      console.log("Registro guardado", data);
    });
  });

  const LikeBTN = document.getElementById('LikeBTN')

  LikeBTN.addEventListener("click", function() {

    fetch("{% url 'Like' prob.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(data => {
        // Cambiar icono segun estado
        document.getElementById("likes-emoji").textContent = data.liked ? "♥︎" : "♡";

        // Actualizar número mostrado
        document.getElementById("likes-count").textContent = data.likes_count;
    });
  });
});
</script>
{% endblock %}
