{% extends "base.html" %}

{% block title %} Title1 {% endblock %}

{% block content %}
<div class="container" style="margin-left: 10px;">
  {% if prob.image %}
    <img src="{{ prob.image.url }}"
         style="float: left; width: 25%; height: 100%; object-fit: cover; border-radius: 10px; margin: 10px; margin-bottom: 0;">
  {% endif %}

  <h1 class="mb-3">{{ prob.title }}</h1>
  <p class="fs-5">{{ prob.text }}</p>
  <br>

  <button id="LikeBTN" {% if request.user.is_authenticated %} class="btn btn-success" {% else %} class ="btn btn-secondary" disabled {% endif %}>
    <span id="likes-emoji">
      {% if request.user in prob.likes.all %}
        ♥︎
      {% else %}
        ♡
      {% endif %}
    </span>
    <span id="likes-count">{{prob.likes_count}}</span>
  </button>

  

  <!-- Botón único -->
  <button {% if request.user.is_authenticated %} id="toggle-sol" class="btn btn-success" {% else %} class="btn btn-secondary" disabled {% endif %}>
    Mostrar soluciones
  </button>
  <br><br>
  {% if not request.user.is_authenticated %}

    <a href="{% url 'Login' %}" class="btn btn-info" style="color: white;">
     Not logged in? Click here to log in.
    </a>

  {% endif %}

  <!-- Contenedor de soluciones -->
  <div id="solutions-container" {% if not solutions %}hidden{% endif %}>
    {% for solution in prob.soluciones.all %}
      <p>{{ solution.text }}</p>
    {% endfor %}
  </div>
</div>

<div style="clear: both;"></div>
<br>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const button = document.getElementById("toggle-sol");
  const container = document.getElementById("solutions-container");

  button.addEventListener("click", function() {
    // Alternar visibilidad en frontend
    container.hidden = !container.hidden;

    // Cambiar texto del botón
    button.textContent = container.hidden ? "Mostrar soluciones" : "Ocultar soluciones";

    // Registrar acción en backend
    fetch("{% url 'toggle_solutions' prob.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      },
      body: JSON.stringify({ show: !container.hidden })
    }).then(res => res.json()).then(data => {
      // opcional: manejar respuesta
      console.log("Registro guardado", data);
    });
  });

  const LikeBTN = document.getElementById('LikeBTN')

  LikeBTN.addEventListener("click", function() {

    fetch("{% url 'Like' prob.id %}", {
      method: "POST",
      headers: {
        "X-CSRFToken": "{{ csrf_token }}",
        "Content-Type": "application/json"
      }
    })
    .then(res => res.json())
    .then(data => {
        // Cambiar icono segun estado
        document.getElementById("likes-emoji").textContent = data.liked ? "♥︎" : "♡";

        // Actualizar número mostrado
        document.getElementById("likes-count").textContent = data.likes_count;
    });
  });
});
</script>
{% endblock %}
